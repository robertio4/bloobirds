import { DataBuilderFormulaType, getFormula } from '.'
import { DataBuilderContext } from '../context'
import { DataBuilderFormulaExtractTime } from './extractTime'

describe('formulas/extractTime', () => {
  const DATETIME = '2021-07-06T02:22:22.000Z'
  const context = new DataBuilderContext({
    datetime: DATETIME,
  })

  it('should find extractTime formula', () => {
    const formula = getFormula({
      $extractTime: DATETIME,
    })
    expect(formula).toBeDefined()
    expect(formula).not.toBeNull()
    expect(formula.type).toEqual(DataBuilderFormulaType.EXTRACT_TIME)
    expect(formula instanceof DataBuilderFormulaExtractTime).toBeTruthy()
    expect((formula as DataBuilderFormulaExtractTime).value).toEqual(DATETIME)
  })

  it('should extract date', () => {
    const formula = new DataBuilderFormulaExtractTime(DATETIME)
    expect(formula.getValue(context)).toEqual('02:22:22')
  })

  it('should extract date from variable', () => {
    const formula = new DataBuilderFormulaExtractTime({
      $var: '$.datetime',
    })
    expect(formula.getValue(context)).toEqual('02:22:22')
  })

  it('should extract time from non-standard date', () => {
    const formula = new DataBuilderFormulaExtractTime('Jun 25, 2022 13:30')
    expect(formula.getValue(context)).toEqual('13:30:00')
  })

  it('should return undefined when non-date value provided', () => {
    let formula = new DataBuilderFormulaExtractTime(null)
    expect(formula.getValue(context)).toBeUndefined()

    formula = new DataBuilderFormulaExtractTime('foo')
    expect(formula.getValue(context)).toBeUndefined()

    formula = new DataBuilderFormulaExtractTime('25')
    expect(formula.getValue(context)).toBeUndefined()
  })
})
