{"version":3,"file":"index.es.js","sources":["../src/components/CursorOverlay.styles.ts","../src/components/Cursor.tsx","../src/hooks/useRequestReRender.ts","../src/hooks/useRefreshOnResize.ts","../src/queries/getCaretPosition.ts","../src/queries/getCursorOverlayState.ts","../src/queries/getSelectionRects.ts","../src/hooks/useCursorOverlayPositions.ts","../src/components/CursorOverlay.tsx"],"sourcesContent":["import { createStyles } from '@udecode/plate-styled-components';\nimport { css } from 'styled-components';\nimport tw from 'twin.macro';\nimport { CursorOverlayProps } from './CursorOverlay';\n\nexport const getCursorOverlayStyles = (props: CursorOverlayProps) =>\n  createStyles(\n    { prefixClassNames: 'CursorOverlay', ...props },\n    {\n      selectionRect: [\n        tw`absolute z-10 pointer-events-none`,\n        css`\n          opacity: 0.3;\n        `,\n      ],\n      caret: [\n        tw`absolute z-10 pointer-events-none`,\n        css`\n          width: 2px;\n        `,\n      ],\n    }\n  );\n","import React from 'react';\nimport { RenderFunction, UnknownObject } from '@udecode/plate-core';\nimport { StyledProps } from '@udecode/plate-styled-components';\nimport { CSSProp } from 'styled-components';\nimport { CursorData, CursorOverlayState, SelectionRect } from '../types';\nimport { getCursorOverlayStyles } from './CursorOverlay.styles';\n\nexport interface CursorProps<\n  TCursorData extends UnknownObject = UnknownObject\n> extends CursorOverlayState<TCursorData>,\n    StyledProps<{\n      caret: CSSProp;\n      selectionRect: CSSProp;\n    }> {\n  /**\n   * Whether to disable the caret.\n   */\n  disableCaret?: boolean;\n\n  /**\n   * Whether to disable the selection rects.\n   */\n  disableSelection?: boolean;\n\n  /**\n   * Custom caret component.\n   * For example, you could display a label next to the caret.\n   * @default styled div\n   */\n  onRenderCaret?: RenderFunction<\n    Pick<CursorProps<TCursorData>, 'data' | 'caretPosition'>\n  >;\n\n  /**\n   * Overrides `Caret` component\n   */\n  onRenderSelectionRect?: RenderFunction<\n    Pick<CursorProps<TCursorData>, 'data'> & {\n      selectionRect: SelectionRect;\n    }\n  >;\n}\n\nexport const Cursor = ({\n  data,\n  selectionRects,\n  caretPosition,\n  disableCaret,\n  disableSelection,\n  onRenderCaret: Caret,\n  onRenderSelectionRect: Rect,\n  ...props\n}: CursorProps<CursorData>) => {\n  if (!data) {\n    return null;\n  }\n\n  const { caret, selectionRect } = getCursorOverlayStyles(props);\n\n  const { style, selectionStyle = style } = data;\n\n  return (\n    <>\n      {!disableSelection &&\n        selectionRects.map((position, i) =>\n          Rect ? (\n            <Rect key={i} data={data} selectionRect={position} />\n          ) : (\n            <div\n              key={i}\n              className={selectionRect?.className}\n              css={selectionRect?.css}\n              style={{\n                ...selectionStyle,\n                ...position,\n              }}\n            />\n          )\n        )}\n      {!disableCaret &&\n        caretPosition &&\n        (Caret ? (\n          <Caret data={data} caretPosition={caretPosition} />\n        ) : (\n          <div\n            className={caret?.className}\n            css={caret?.css}\n            style={{ ...caretPosition, ...style }}\n          />\n        ))}\n    </>\n  );\n};\n","import { useCallback, useEffect, useRef, useState } from 'react';\n\nexport const useRequestReRender = () => {\n  const [, setUpdateCounter] = useState(0);\n  const animationFrameRef = useRef<number | null>(null);\n\n  const requestReRender = useCallback((immediate = false) => {\n    if (animationFrameRef.current && !immediate) {\n      return;\n    }\n\n    if (!immediate) {\n      animationFrameRef.current = requestAnimationFrame(() => {\n        setUpdateCounter((state) => state + 1);\n        animationFrameRef.current = null;\n      });\n      return;\n    }\n\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n      animationFrameRef.current = null;\n    }\n\n    setUpdateCounter((state) => state + 1);\n  }, []);\n\n  useEffect(() => {\n    if (animationFrameRef.current) {\n      cancelAnimationFrame(animationFrameRef.current);\n      animationFrameRef.current = null;\n    }\n  });\n\n  useEffect(\n    () => () => {\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n    },\n    []\n  );\n\n  return requestReRender;\n};\n","import { MutableRefObject, useCallback, useEffect } from 'react';\nimport { Range } from 'slate';\nimport { CursorOverlayProps } from '../components/index';\nimport { SelectionRect } from '../types';\nimport { useRequestReRender } from './useRequestReRender';\n\nexport interface UseRefreshOnResizeOptions\n  extends Pick<CursorOverlayProps, 'refreshOnResize' | 'containerRef'> {\n  selectionRectCache: MutableRefObject<WeakMap<Range, SelectionRect[]>>;\n}\n\nexport const useRefreshOnResize = ({\n  containerRef,\n  refreshOnResize,\n  selectionRectCache,\n}: UseRefreshOnResizeOptions) => {\n  const requestReRender = useRequestReRender();\n\n  // Reset the selection rect cache and request re-render.\n  const refresh = useCallback(\n    (sync = false) => {\n      selectionRectCache.current = new WeakMap();\n      requestReRender(sync);\n    },\n    [requestReRender, selectionRectCache]\n  );\n\n  // Refresh on container resize\n  useEffect(() => {\n    if (!refreshOnResize || !containerRef?.current) {\n      return;\n    }\n\n    const resizeObserver = new ResizeObserver(() => refresh());\n    resizeObserver.observe(containerRef.current);\n    return () => resizeObserver.disconnect();\n  }, [containerRef, refresh, refreshOnResize]);\n\n  return {\n    refresh,\n  };\n};\n","import { Range } from 'slate';\nimport { CaretPosition, SelectionRect } from '../types';\n\n/**\n * Get the caret position of a range from selectionRects.\n */\nexport const getCaretPosition = (\n  selectionRects: SelectionRect[],\n  range: Range\n): CaretPosition | null => {\n  const isCollapsed = range && Range.isCollapsed(range);\n  const isBackward = range && Range.isBackward(range);\n  const anchorRect = selectionRects[isBackward ? 0 : selectionRects.length - 1];\n\n  if (!anchorRect) {\n    return null;\n  }\n\n  return {\n    height: anchorRect.height,\n    top: anchorRect.top,\n    left: anchorRect.left + (isBackward || isCollapsed ? 0 : anchorRect.width),\n  };\n};\n","import { UnknownObject } from '@udecode/plate-core';\nimport { CursorOverlayProps } from '../components/index';\nimport { FROZEN_EMPTY_ARRAY } from '../hooks/index';\nimport { CursorOverlayState, SelectionRect } from '../types';\nimport { getCaretPosition } from './getCaretPosition';\n\n/**\n * Get cursor overlay state from selection rects.\n */\nexport const getCursorOverlayState = <\n  TCursorData extends UnknownObject = UnknownObject\n>({\n  cursors: cursorStates,\n  selectionRects,\n}: Pick<CursorOverlayProps<TCursorData>, 'cursors'> & {\n  selectionRects: Record<string, SelectionRect[]>;\n}): CursorOverlayState<TCursorData>[] => {\n  if (!cursorStates) return [];\n\n  return Object.entries(cursorStates).map(([key, cursorState]) => {\n    const selection = cursorState?.selection ?? null;\n    const rects = selectionRects[key] ?? FROZEN_EMPTY_ARRAY;\n\n    const caretPosition = selection ? getCaretPosition(rects, selection) : null;\n\n    return {\n      ...cursorState,\n      selection,\n      caretPosition,\n      selectionRects: rects,\n    };\n  });\n};\n","import {\n  getNodeEntries,\n  isText,\n  toDOMNode,\n  toDOMRange,\n  TReactEditor,\n  Value,\n} from '@udecode/plate-core';\nimport { Path, Range } from 'slate';\nimport { SelectionRect } from '../types';\n\nexport const getSelectionRects = <V extends Value>(\n  editor: TReactEditor<V>,\n  {\n    range,\n    xOffset,\n    yOffset,\n  }: {\n    range: Range;\n    xOffset: number;\n    yOffset: number;\n  }\n): SelectionRect[] => {\n  const [start, end] = Range.edges(range);\n  const domRange = toDOMRange(editor, range);\n  if (!domRange) {\n    return [];\n  }\n\n  const selectionRects: SelectionRect[] = [];\n  const textEntries = getNodeEntries(editor, {\n    at: range,\n    match: isText,\n  });\n\n  for (const [textNode, textPath] of textEntries) {\n    const domNode = toDOMNode(editor, textNode);\n    if (!domNode) {\n      return [];\n    }\n\n    const isStartNode = Path.equals(textPath, start.path);\n    const isEndNode = Path.equals(textPath, end.path);\n\n    let clientRects: DOMRectList | null = null;\n    if (isStartNode || isEndNode) {\n      const nodeRange = document.createRange();\n      nodeRange.selectNode(domNode);\n\n      if (isStartNode) {\n        nodeRange.setStart(domRange.startContainer, domRange.startOffset);\n      }\n      if (isEndNode) {\n        nodeRange.setEnd(domRange.endContainer, domRange.endOffset);\n      }\n\n      clientRects = nodeRange.getClientRects();\n    } else {\n      clientRects = domNode.getClientRects();\n    }\n\n    for (let i = 0; i < clientRects.length; i++) {\n      const clientRect = clientRects.item(i);\n      if (!clientRect) {\n        continue;\n      }\n\n      selectionRects.push({\n        width: clientRect.width,\n        height: clientRect.height,\n        top: clientRect.top - yOffset,\n        left: clientRect.left - xOffset,\n      });\n    }\n  }\n\n  return selectionRects;\n};\n","import { useCallback, useLayoutEffect, useMemo, useRef, useState } from 'react';\nimport { UnknownObject, useEditorRef } from '@udecode/plate-core';\nimport { Range } from 'slate';\nimport { CursorOverlayProps } from '../components/index';\nimport { getCursorOverlayState } from '../queries/getCursorOverlayState';\nimport { getSelectionRects } from '../queries/getSelectionRects';\nimport { CursorState, SelectionRect } from '../types';\nimport { useRefreshOnResize } from './useRefreshOnResize';\n\nexport const FROZEN_EMPTY_ARRAY = (Object.freeze(\n  []\n) as unknown) as SelectionRect[];\n\nexport const useCursorOverlayPositions = <TCursorData extends UnknownObject>({\n  containerRef,\n  cursors: cursorStates,\n  refreshOnResize = true,\n}: CursorOverlayProps<TCursorData> = {}) => {\n  const editor = useEditorRef();\n\n  const selectionRectCache = useRef<WeakMap<Range, SelectionRect[]>>(\n    new WeakMap()\n  );\n\n  const [selectionRects, setSelectionRects] = useState<\n    Record<string, SelectionRect[]>\n  >({});\n\n  const updateSelectionRects = useCallback(() => {\n    // We have a container ref but the ref is null => container\n    // isn't mounted to we can't calculate the selection rects.\n    if (!containerRef?.current) return;\n    if (!cursorStates) return;\n\n    let xOffset = 0;\n    let yOffset = 0;\n    if (containerRef) {\n      const contentRect = containerRef.current!.getBoundingClientRect();\n      xOffset = contentRect.x;\n      yOffset = contentRect.y;\n    }\n\n    let selectionRectsChanged =\n      Object.keys(selectionRects).length !== Object.keys(cursorStates).length;\n\n    const getCachedSelectionRects = ({\n      cursor,\n    }: {\n      cursor: CursorState<TCursorData>;\n    }) => {\n      const range = cursor.selection;\n\n      if (!range) {\n        return FROZEN_EMPTY_ARRAY;\n      }\n\n      const cached = selectionRectCache.current.get(range);\n      if (cached) {\n        return cached;\n      }\n\n      const rects = getSelectionRects(editor, { range, xOffset, yOffset });\n      selectionRectsChanged = true;\n      selectionRectCache.current.set(range, rects);\n\n      return rects;\n    };\n\n    const updated: Record<string, SelectionRect[]> = Object.fromEntries(\n      Object.entries(cursorStates).map(([key, cursor]) => [\n        key,\n        getCachedSelectionRects({\n          cursor,\n        }),\n      ])\n    );\n\n    if (selectionRectsChanged) {\n      setSelectionRects(updated);\n    }\n  }, [containerRef, cursorStates, editor, selectionRects]);\n\n  // Update selection rects after paint\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  useLayoutEffect(() => {\n    updateSelectionRects();\n  });\n\n  const cursors = useMemo(\n    () =>\n      getCursorOverlayState({\n        selectionRects,\n        cursors: cursorStates,\n      }),\n    [cursorStates, selectionRects]\n  );\n\n  const { refresh } = useRefreshOnResize({\n    containerRef,\n    selectionRectCache,\n    refreshOnResize,\n  });\n\n  return { refresh, cursors };\n};\n","import React, { RefObject } from 'react';\nimport {\n  RenderFunction,\n  UnknownObject,\n  usePlateSelectors,\n} from '@udecode/plate-core';\nimport { useCursorOverlayPositions } from '../hooks/useCursorOverlayPositions';\nimport { CursorData, CursorState } from '../types';\nimport { Cursor, CursorProps } from './Cursor';\n\nexport interface CursorOverlayProps<\n  TCursorData extends UnknownObject = UnknownObject\n> extends Pick<\n    CursorProps<CursorData>,\n    | 'disableCaret'\n    | 'disableSelection'\n    | 'onRenderCaret'\n    | 'onRenderSelectionRect'\n    | 'as'\n    | 'classNames'\n    | 'prefixClassNames'\n    | 'styles'\n  > {\n  /**\n   * Cursor states to use for calculating the overlay positions, by key.\n   */\n  cursors?: Record<string, CursorState<TCursorData>>;\n\n  /**\n   * Container the overlay will be rendered in.\n   * If set, all returned overlay positions will be relative to this container.\n   */\n  containerRef?: RefObject<HTMLElement>;\n\n  /**\n   * Whether to refresh the cursor overlay positions on container resize.\n   * @default true\n   */\n  refreshOnResize?: boolean;\n\n  /**\n   * Overrides `Cursor` component.\n   */\n  onRenderCursor?: RenderFunction<CursorProps>;\n}\n\nexport const CursorOverlayContent = <\n  TCursorData extends UnknownObject = UnknownObject\n>({\n  as,\n  classNames,\n  prefixClassNames,\n  styles,\n  onRenderCursor: CursorComponent = Cursor,\n  onRenderSelectionRect,\n  onRenderCaret,\n  ...props\n}: CursorOverlayProps<TCursorData>) => {\n  const { disableCaret, disableSelection } = props;\n\n  const { cursors } = useCursorOverlayPositions(props);\n\n  const cursorProps = {\n    as,\n    classNames,\n    prefixClassNames,\n    styles,\n    onRenderSelectionRect,\n    onRenderCaret,\n    disableCaret,\n    disableSelection,\n  };\n\n  return (\n    <>\n      {cursors.map((cursor) => (\n        <CursorComponent key={cursor.key} {...cursorProps} {...cursor} />\n      ))}\n    </>\n  );\n};\n\nexport const CursorOverlay = <\n  TCursorData extends UnknownObject = UnknownObject\n>(\n  props: CursorOverlayProps<TCursorData>\n) => {\n  const isRendered = usePlateSelectors().isRendered();\n\n  if (!isRendered) return null;\n\n  return <CursorOverlayContent {...props} />;\n};\n"],"names":["getCursorOverlayStyles","props","createStyles","prefixClassNames","selectionRect","css","caret","Cursor","data","selectionRects","caretPosition","disableCaret","disableSelection","onRenderCaret","Caret","onRenderSelectionRect","Rect","style","selectionStyle","map","position","i","className","useRequestReRender","setUpdateCounter","useState","animationFrameRef","useRef","requestReRender","useCallback","immediate","current","requestAnimationFrame","state","cancelAnimationFrame","useEffect","useRefreshOnResize","containerRef","refreshOnResize","selectionRectCache","refresh","sync","WeakMap","resizeObserver","ResizeObserver","observe","disconnect","getCaretPosition","range","isCollapsed","Range","isBackward","anchorRect","length","height","top","left","width","getCursorOverlayState","cursors","cursorStates","Object","entries","key","cursorState","selection","rects","FROZEN_EMPTY_ARRAY","getSelectionRects","editor","xOffset","yOffset","start","end","edges","domRange","toDOMRange","textEntries","getNodeEntries","at","match","isText","textNode","textPath","domNode","toDOMNode","isStartNode","Path","equals","path","isEndNode","clientRects","nodeRange","document","createRange","selectNode","setStart","startContainer","startOffset","setEnd","endContainer","endOffset","getClientRects","clientRect","item","push","freeze","useCursorOverlayPositions","useEditorRef","setSelectionRects","updateSelectionRects","contentRect","getBoundingClientRect","x","y","selectionRectsChanged","keys","getCachedSelectionRects","cursor","cached","get","set","updated","fromEntries","useLayoutEffect","useMemo","CursorOverlayContent","as","classNames","styles","onRenderCursor","CursorComponent","cursorProps","CursorOverlay","isRendered","usePlateSelectors"],"mappings":";;;;;;MAKaA,sBAAsB,GAAIC,KAAD,IACpCC,YAAY,CACV;AAAEC,EAAAA,gBAAgB,EAAE,eAApB;EAAqC,GAAGF,KAAAA;AAAxC,CADU,EAEV;AACEG,EAAAA,aAAa,EAAE,CACX;AAAA,IAAA,UAAA,EAAA,UAAA;AAAA,IAAA,QAAA,EAAA,IAAA;AAAA,IAAA,eAAA,EAAA,MAAA;GADW,EAEbC,GAFa,CADjB,CAAA,cAAA,CAAA,CAAA,CAAA;AAOEC,EAAAA,KAAK,EAAE,CACH;AAAA,IAAA,UAAA,EAAA,UAAA;AAAA,IAAA,QAAA,EAAA,IAAA;AAAA,IAAA,eAAA,EAAA,MAAA;AAAA,GADG,EAELD,GAFK,CAAA,CAAA,YAAA,CAAA,CAAA,CAAA;AAPT,CAFU;;ACqCP,MAAME,MAAM,GAAG,CAAC;EACrBC,IADqB;EAErBC,cAFqB;EAGrBC,aAHqB;EAIrBC,YAJqB;EAKrBC,gBALqB;AAMrBC,EAAAA,aAAa,EAAEC,KANM;AAOrBC,EAAAA,qBAAqB,EAAEC,IAPF;EAQrB,GAAGf,KAAAA;AARkB,CAAD,KASS;EAC7B,IAAI,CAACO,IAAL,EAAW;AACT,IAAA,OAAO,IAAP,CAAA;AACD,GAAA;;EAED,MAAM;IAAEF,KAAF;AAASF,IAAAA,aAAAA;GAAkBJ,GAAAA,sBAAsB,CAACC,KAAD,CAAvD,CAAA;EAEA,MAAM;IAAEgB,KAAF;AAASC,IAAAA,cAAc,GAAGD,KAAAA;AAA1B,GAAA,GAAoCT,IAA1C,CAAA;AAEA,EAAA,oBACE,0CACG,CAACI,gBAAD,IACCH,cAAc,CAACU,GAAf,CAAmB,CAACC,QAAD,EAAWC,CAAX,KACjBL,IAAI,gBACF,oBAAC,IAAD,EAAA;AAAM,IAAA,GAAG,EAAEK,CAAX;AAAc,IAAA,IAAI,EAAEb,IAApB;AAA0B,IAAA,aAAa,EAAEY,QAAAA;AAAzC,GAAA,CADE,gBAGF,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA;AACE,IAAA,GAAG,EAAEC,CADP;AAEE,IAAA,SAAS,EAAEjB,aAAF,KAAA,IAAA,IAAEA,aAAF,KAAEA,KAAAA,CAAAA,GAAAA,KAAAA,CAAAA,GAAAA,aAAa,CAAEkB,SAF5B;IAIE,KAAK,EAAE,EACL,GAAGJ,cADE;MAEL,GAAGE,QAAAA;KANP;AAAA,IAAA,KAAA,EAGOhB,aAHP,KAAA,IAAA,IAGOA,aAHP,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAGOA,aAAa,CAAEC,GAAAA;GAP1B,CAAA,CAFJ,EAiBG,CAACM,YAAD,IACCD,aADD,KAEEI,KAAK,gBACJ,KAAA,CAAA,aAAA,CAAC,KAAD,EAAA;AAAO,IAAA,IAAI,EAAEN,IAAb;AAAmB,IAAA,aAAa,EAAEE,aAAAA;AAAlC,GAAA,CADI,gBAGJ,KAAA,CAAA,aAAA,CAAA,WAAA,EAAA;AACE,IAAA,SAAS,EAAEJ,KAAF,KAAA,IAAA,IAAEA,KAAF,KAAEA,KAAAA,CAAAA,GAAAA,KAAAA,CAAAA,GAAAA,KAAK,CAAEgB,SADpB;IAGE,KAAK,EAAE,EAAE,GAAGZ,aAAL;MAAoB,GAAGO,KAAAA;KAHhC;AAAA,IAAA,MAAA,EAEOX,KAFP,KAAA,IAAA,IAEOA,KAFP,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAEOA,KAAK,CAAED,GAAAA;AAFd,GAAA,CALH,CAjBH,CADF,CAAA;AA+BD,EAjDM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzCA,MAAMkB,kBAAkB,GAAG,MAAM;AACtC,EAAA,MAAM,GAAGC,gBAAH,CAAA,GAAuBC,QAAQ,CAAC,CAAD,CAArC,CAAA;AACA,EAAA,MAAMC,iBAAiB,GAAGC,MAAM,CAAgB,IAAhB,CAAhC,CAAA;EAEA,MAAMC,eAAe,GAAGC,WAAW,CAAC,CAACC,SAAS,GAAG,KAAb,KAAuB;AACzD,IAAA,IAAIJ,iBAAiB,CAACK,OAAlB,IAA6B,CAACD,SAAlC,EAA6C;AAC3C,MAAA,OAAA;AACD,KAAA;;IAED,IAAI,CAACA,SAAL,EAAgB;AACdJ,MAAAA,iBAAiB,CAACK,OAAlB,GAA4BC,qBAAqB,CAAC,MAAM;AACtDR,QAAAA,gBAAgB,CAAES,KAAD,IAAWA,KAAK,GAAG,CAApB,CAAhB,CAAA;QACAP,iBAAiB,CAACK,OAAlB,GAA4B,IAA5B,CAAA;AACD,OAHgD,CAAjD,CAAA;AAIA,MAAA,OAAA;AACD,KAAA;;IAED,IAAIL,iBAAiB,CAACK,OAAtB,EAA+B;AAC7BG,MAAAA,oBAAoB,CAACR,iBAAiB,CAACK,OAAnB,CAApB,CAAA;MACAL,iBAAiB,CAACK,OAAlB,GAA4B,IAA5B,CAAA;AACD,KAAA;;AAEDP,IAAAA,gBAAgB,CAAES,KAAD,IAAWA,KAAK,GAAG,CAApB,CAAhB,CAAA;GAlBiC,EAmBhC,EAnBgC,CAAnC,CAAA;AAqBAE,EAAAA,SAAS,CAAC,MAAM;IACd,IAAIT,iBAAiB,CAACK,OAAtB,EAA+B;AAC7BG,MAAAA,oBAAoB,CAACR,iBAAiB,CAACK,OAAnB,CAApB,CAAA;MACAL,iBAAiB,CAACK,OAAlB,GAA4B,IAA5B,CAAA;AACD,KAAA;AACF,GALQ,CAAT,CAAA;EAOAI,SAAS,CACP,MAAM,MAAM;IACV,IAAIT,iBAAiB,CAACK,OAAtB,EAA+B;AAC7BG,MAAAA,oBAAoB,CAACR,iBAAiB,CAACK,OAAnB,CAApB,CAAA;AACD,KAAA;GAJI,EAMP,EANO,CAAT,CAAA;AASA,EAAA,OAAOH,eAAP,CAAA;AACD;;ACjCM,MAAMQ,kBAAkB,GAAG,CAAC;EACjCC,YADiC;EAEjCC,eAFiC;AAGjCC,EAAAA,kBAAAA;AAHiC,CAAD,KAID;AAC/B,EAAA,MAAMX,eAAe,GAAGL,kBAAkB,EAA1C,CAD+B;;EAI/B,MAAMiB,OAAO,GAAGX,WAAW,CACzB,CAACY,IAAI,GAAG,KAAR,KAAkB;AAChBF,IAAAA,kBAAkB,CAACR,OAAnB,GAA6B,IAAIW,OAAJ,EAA7B,CAAA;IACAd,eAAe,CAACa,IAAD,CAAf,CAAA;GAHuB,EAKzB,CAACb,eAAD,EAAkBW,kBAAlB,CALyB,CAA3B,CAJ+B;;AAa/BJ,EAAAA,SAAS,CAAC,MAAM;AACd,IAAA,IAAI,CAACG,eAAD,IAAoB,EAACD,YAAD,KAAA,IAAA,IAACA,YAAD,KAAA,KAAA,CAAA,IAACA,YAAY,CAAEN,OAAf,CAAxB,EAAgD;AAC9C,MAAA,OAAA;AACD,KAAA;;IAED,MAAMY,cAAc,GAAG,IAAIC,cAAJ,CAAmB,MAAMJ,OAAO,EAAhC,CAAvB,CAAA;AACAG,IAAAA,cAAc,CAACE,OAAf,CAAuBR,YAAY,CAACN,OAApC,CAAA,CAAA;AACA,IAAA,OAAO,MAAMY,cAAc,CAACG,UAAf,EAAb,CAAA;GAPO,EAQN,CAACT,YAAD,EAAeG,OAAf,EAAwBF,eAAxB,CARM,CAAT,CAAA;EAUA,OAAO;AACLE,IAAAA,OAAAA;GADF,CAAA;AAGD;;ACtCD;AACA;AACA;MACaO,gBAAgB,GAAG,CAC9BtC,cAD8B,EAE9BuC,KAF8B,KAGL;EACzB,MAAMC,WAAW,GAAGD,KAAK,IAAIE,KAAK,CAACD,WAAN,CAAkBD,KAAlB,CAA7B,CAAA;EACA,MAAMG,UAAU,GAAGH,KAAK,IAAIE,KAAK,CAACC,UAAN,CAAiBH,KAAjB,CAA5B,CAAA;AACA,EAAA,MAAMI,UAAU,GAAG3C,cAAc,CAAC0C,UAAU,GAAG,CAAH,GAAO1C,cAAc,CAAC4C,MAAf,GAAwB,CAA1C,CAAjC,CAAA;;EAEA,IAAI,CAACD,UAAL,EAAiB;AACf,IAAA,OAAO,IAAP,CAAA;AACD,GAAA;;EAED,OAAO;IACLE,MAAM,EAAEF,UAAU,CAACE,MADd;IAELC,GAAG,EAAEH,UAAU,CAACG,GAFX;AAGLC,IAAAA,IAAI,EAAEJ,UAAU,CAACI,IAAX,IAAmBL,UAAU,IAAIF,WAAd,GAA4B,CAA5B,GAAgCG,UAAU,CAACK,KAA9D,CAAA;GAHR,CAAA;AAKD;;ACjBD;AACA;AACA;;AACO,MAAMC,qBAAqB,GAAG,CAEnC;AACAC,EAAAA,OAAO,EAAEC,YADT;AAEAnD,EAAAA,cAAAA;AAFA,CAFmC,KAOI;AACvC,EAAA,IAAI,CAACmD,YAAL,EAAmB,OAAO,EAAP,CAAA;AAEnB,EAAA,OAAOC,MAAM,CAACC,OAAP,CAAeF,YAAf,CAA6BzC,CAAAA,GAA7B,CAAiC,CAAC,CAAC4C,GAAD,EAAMC,WAAN,CAAD,KAAwB;AAAA,IAAA,IAAA,qBAAA,EAAA,mBAAA,CAAA;;IAC9D,MAAMC,SAAS,GAAGD,CAAAA,qBAAAA,GAAAA,WAAH,KAAGA,IAAAA,IAAAA,WAAH,uBAAGA,WAAW,CAAEC,SAAhB,MAAA,IAAA,IAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,qBAAA,GAA6B,IAA5C,CAAA;AACA,IAAA,MAAMC,KAAK,GAAGzD,CAAAA,mBAAAA,GAAAA,cAAc,CAACsD,GAAD,CAAjB,qEAA0BI,kBAArC,CAAA;IAEA,MAAMzD,aAAa,GAAGuD,SAAS,GAAGlB,gBAAgB,CAACmB,KAAD,EAAQD,SAAR,CAAnB,GAAwC,IAAvE,CAAA;IAEA,OAAO,EACL,GAAGD,WADE;MAELC,SAFK;MAGLvD,aAHK;AAILD,MAAAA,cAAc,EAAEyD,KAAAA;KAJlB,CAAA;AAMD,GAZM,CAAP,CAAA;AAaD;;ACrBYE,MAAAA,iBAAiB,GAAG,CAC/BC,MAD+B,EAE/B;EACErB,KADF;EAEEsB,OAFF;AAGEC,EAAAA,OAAAA;AAHF,CAF+B,KAWX;EACpB,MAAM,CAACC,KAAD,EAAQC,GAAR,CAAA,GAAevB,KAAK,CAACwB,KAAN,CAAY1B,KAAZ,CAArB,CAAA;AACA,EAAA,MAAM2B,QAAQ,GAAGC,UAAU,CAACP,MAAD,EAASrB,KAAT,CAA3B,CAAA;;EACA,IAAI,CAAC2B,QAAL,EAAe;AACb,IAAA,OAAO,EAAP,CAAA;AACD,GAAA;;EAED,MAAMlE,cAA+B,GAAG,EAAxC,CAAA;AACA,EAAA,MAAMoE,WAAW,GAAGC,cAAc,CAACT,MAAD,EAAS;AACzCU,IAAAA,EAAE,EAAE/B,KADqC;AAEzCgC,IAAAA,KAAK,EAAEC,MAAAA;AAFkC,GAAT,CAAlC,CAAA;;EAKA,KAAK,MAAM,CAACC,QAAD,EAAWC,QAAX,CAAX,IAAmCN,WAAnC,EAAgD;AAC9C,IAAA,MAAMO,OAAO,GAAGC,SAAS,CAAChB,MAAD,EAASa,QAAT,CAAzB,CAAA;;IACA,IAAI,CAACE,OAAL,EAAc;AACZ,MAAA,OAAO,EAAP,CAAA;AACD,KAAA;;IAED,MAAME,WAAW,GAAGC,IAAI,CAACC,MAAL,CAAYL,QAAZ,EAAsBX,KAAK,CAACiB,IAA5B,CAApB,CAAA;IACA,MAAMC,SAAS,GAAGH,IAAI,CAACC,MAAL,CAAYL,QAAZ,EAAsBV,GAAG,CAACgB,IAA1B,CAAlB,CAAA;IAEA,IAAIE,WAA+B,GAAG,IAAtC,CAAA;;IACA,IAAIL,WAAW,IAAII,SAAnB,EAA8B;AAC5B,MAAA,MAAME,SAAS,GAAGC,QAAQ,CAACC,WAAT,EAAlB,CAAA;MACAF,SAAS,CAACG,UAAV,CAAqBX,OAArB,CAAA,CAAA;;AAEA,MAAA,IAAIE,WAAJ,EAAiB;QACfM,SAAS,CAACI,QAAV,CAAmBrB,QAAQ,CAACsB,cAA5B,EAA4CtB,QAAQ,CAACuB,WAArD,CAAA,CAAA;AACD,OAAA;;AACD,MAAA,IAAIR,SAAJ,EAAe;QACbE,SAAS,CAACO,MAAV,CAAiBxB,QAAQ,CAACyB,YAA1B,EAAwCzB,QAAQ,CAAC0B,SAAjD,CAAA,CAAA;AACD,OAAA;;AAEDV,MAAAA,WAAW,GAAGC,SAAS,CAACU,cAAV,EAAd,CAAA;AACD,KAZD,MAYO;AACLX,MAAAA,WAAW,GAAGP,OAAO,CAACkB,cAAR,EAAd,CAAA;AACD,KAAA;;AAED,IAAA,KAAK,IAAIjF,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGsE,WAAW,CAACtC,MAAhC,EAAwChC,CAAC,EAAzC,EAA6C;AAC3C,MAAA,MAAMkF,UAAU,GAAGZ,WAAW,CAACa,IAAZ,CAAiBnF,CAAjB,CAAnB,CAAA;;MACA,IAAI,CAACkF,UAAL,EAAiB;AACf,QAAA,SAAA;AACD,OAAA;;MAED9F,cAAc,CAACgG,IAAf,CAAoB;QAClBhD,KAAK,EAAE8C,UAAU,CAAC9C,KADA;QAElBH,MAAM,EAAEiD,UAAU,CAACjD,MAFD;AAGlBC,QAAAA,GAAG,EAAEgD,UAAU,CAAChD,GAAX,GAAiBgB,OAHJ;AAIlBf,QAAAA,IAAI,EAAE+C,UAAU,CAAC/C,IAAX,GAAkBc,OAAAA;OAJ1B,CAAA,CAAA;AAMD,KAAA;AACF,GAAA;;AAED,EAAA,OAAO7D,cAAP,CAAA;AACD;;ACpEM,MAAM0D,kBAAkB,GAAIN,MAAM,CAAC6C,MAAP,CACjC,EADiC,EAA5B;AAIA,MAAMC,yBAAyB,GAAG,CAAoC;EAC3EtE,YAD2E;AAE3EsB,EAAAA,OAAO,EAAEC,YAFkE;AAG3EtB,EAAAA,eAAe,GAAG,IAAA;AAHyD,CAAA,GAIxC,EAJI,KAIG;EAC1C,MAAM+B,MAAM,GAAGuC,YAAY,EAA3B,CAAA;AAEA,EAAA,MAAMrE,kBAAkB,GAAGZ,MAAM,CAC/B,IAAIe,OAAJ,EAD+B,CAAjC,CAAA;EAIA,MAAM,CAACjC,cAAD,EAAiBoG,iBAAjB,IAAsCpF,QAAQ,CAElD,EAFkD,CAApD,CAAA;AAIA,EAAA,MAAMqF,oBAAoB,GAAGjF,WAAW,CAAC,MAAM;AAC7C;AACA;IACA,IAAI,EAACQ,YAAD,KAACA,IAAAA,IAAAA,YAAD,eAACA,YAAY,CAAEN,OAAf,CAAJ,EAA4B,OAAA;IAC5B,IAAI,CAAC6B,YAAL,EAAmB,OAAA;IAEnB,IAAIU,OAAO,GAAG,CAAd,CAAA;IACA,IAAIC,OAAO,GAAG,CAAd,CAAA;;AACA,IAAA,IAAIlC,YAAJ,EAAkB;AAChB,MAAA,MAAM0E,WAAW,GAAG1E,YAAY,CAACN,OAAb,CAAsBiF,qBAAtB,EAApB,CAAA;MACA1C,OAAO,GAAGyC,WAAW,CAACE,CAAtB,CAAA;MACA1C,OAAO,GAAGwC,WAAW,CAACG,CAAtB,CAAA;AACD,KAAA;;AAED,IAAA,IAAIC,qBAAqB,GACvBtD,MAAM,CAACuD,IAAP,CAAY3G,cAAZ,CAAA,CAA4B4C,MAA5B,KAAuCQ,MAAM,CAACuD,IAAP,CAAYxD,YAAZ,EAA0BP,MADnE,CAAA;;IAGA,MAAMgE,uBAAuB,GAAG,CAAC;AAC/BC,MAAAA,MAAAA;AAD+B,KAAD,KAI1B;AACJ,MAAA,MAAMtE,KAAK,GAAGsE,MAAM,CAACrD,SAArB,CAAA;;MAEA,IAAI,CAACjB,KAAL,EAAY;AACV,QAAA,OAAOmB,kBAAP,CAAA;AACD,OAAA;;MAED,MAAMoD,MAAM,GAAGhF,kBAAkB,CAACR,OAAnB,CAA2ByF,GAA3B,CAA+BxE,KAA/B,CAAf,CAAA;;AACA,MAAA,IAAIuE,MAAJ,EAAY;AACV,QAAA,OAAOA,MAAP,CAAA;AACD,OAAA;;AAED,MAAA,MAAMrD,KAAK,GAAGE,iBAAiB,CAACC,MAAD,EAAS;QAAErB,KAAF;QAASsB,OAAT;AAAkBC,QAAAA,OAAAA;AAAlB,OAAT,CAA/B,CAAA;AACA4C,MAAAA,qBAAqB,GAAG,IAAxB,CAAA;AACA5E,MAAAA,kBAAkB,CAACR,OAAnB,CAA2B0F,GAA3B,CAA+BzE,KAA/B,EAAsCkB,KAAtC,CAAA,CAAA;AAEA,MAAA,OAAOA,KAAP,CAAA;KApBF,CAAA;;IAuBA,MAAMwD,OAAwC,GAAG7D,MAAM,CAAC8D,WAAP,CAC/C9D,MAAM,CAACC,OAAP,CAAeF,YAAf,CAAA,CAA6BzC,GAA7B,CAAiC,CAAC,CAAC4C,GAAD,EAAMuD,MAAN,CAAD,KAAmB,CAClDvD,GADkD,EAElDsD,uBAAuB,CAAC;AACtBC,MAAAA,MAAAA;KADqB,CAF2B,CAApD,CAD+C,CAAjD,CAAA;;AASA,IAAA,IAAIH,qBAAJ,EAA2B;MACzBN,iBAAiB,CAACa,OAAD,CAAjB,CAAA;AACD,KAAA;AACF,GApDuC,EAoDrC,CAACrF,YAAD,EAAeuB,YAAf,EAA6BS,MAA7B,EAAqC5D,cAArC,CApDqC,CAAxC,CAX0C;AAkE1C;;AACAmH,EAAAA,eAAe,CAAC,MAAM;IACpBd,oBAAoB,EAAA,CAAA;AACrB,GAFc,CAAf,CAAA;AAIA,EAAA,MAAMnD,OAAO,GAAGkE,OAAO,CACrB,MACEnE,qBAAqB,CAAC;IACpBjD,cADoB;AAEpBkD,IAAAA,OAAO,EAAEC,YAAAA;AAFW,GAAD,CAFF,EAMrB,CAACA,YAAD,EAAenD,cAAf,CANqB,CAAvB,CAAA;EASA,MAAM;AAAE+B,IAAAA,OAAAA;AAAF,GAAA,GAAcJ,kBAAkB,CAAC;IACrCC,YADqC;IAErCE,kBAFqC;AAGrCD,IAAAA,eAAAA;AAHqC,GAAD,CAAtC,CAAA;EAMA,OAAO;IAAEE,OAAF;AAAWmB,IAAAA,OAAAA;GAAlB,CAAA;AACD;;AC1DM,MAAMmE,oBAAoB,GAAG,CAElC;EACAC,EADA;EAEAC,UAFA;EAGA7H,gBAHA;EAIA8H,MAJA;EAKAC,cAAc,EAAEC,eAAe,GAAG5H,MALlC;EAMAQ,qBANA;EAOAF,aAPA;EAQA,GAAGZ,KAAAA;AARH,CAFkC,KAWG;EACrC,MAAM;IAAEU,YAAF;AAAgBC,IAAAA,gBAAAA;AAAhB,GAAA,GAAqCX,KAA3C,CAAA;EAEA,MAAM;AAAE0D,IAAAA,OAAAA;GAAYgD,GAAAA,yBAAyB,CAAC1G,KAAD,CAA7C,CAAA;AAEA,EAAA,MAAMmI,WAAW,GAAG;IAClBL,EADkB;IAElBC,UAFkB;IAGlB7H,gBAHkB;IAIlB8H,MAJkB;IAKlBlH,qBALkB;IAMlBF,aANkB;IAOlBF,YAPkB;AAQlBC,IAAAA,gBAAAA;GARF,CAAA;EAWA,oBACE,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,EACG+C,OAAO,CAACxC,GAAR,CAAamG,MAAD,iBACX,oBAAC,eAAD,EAAA,QAAA,CAAA;IAAiB,GAAG,EAAEA,MAAM,CAACvD,GAAAA;AAA7B,GAAA,EAAsCqE,WAAtC,EAAuDd,MAAvD,CAAA,CADD,CADH,CADF,CAAA;AAOD,EAlCM;AAoCMe,MAAAA,aAAa,GAGxBpI,KAH2B,IAIxB;AACH,EAAA,MAAMqI,UAAU,GAAGC,iBAAiB,EAAA,CAAGD,UAApB,EAAnB,CAAA;AAEA,EAAA,IAAI,CAACA,UAAL,EAAiB,OAAO,IAAP,CAAA;AAEjB,EAAA,oBAAO,KAAC,CAAA,aAAA,CAAA,oBAAD,EAA0BrI,KAA1B,CAAP,CAAA;AACD;;;;"}